package main

import (
	"encoding/json"
	"fmt"
	"log"
	"os"
	"strings"

	"golang.org/x/text/cases"
	"golang.org/x/text/language"
)

const (
	// API_CALLS is the file name for the api calls
	APICalls = "./calls.go"

	// SUBSCRIPTION_CALLS is the file name for the subscription calls
	SubscriptionCalls = "./subscription_calls.go"

	// SCHEMA_PATH is the path to the schema files
	SchemaPath = "./deriv-api-docs/config/v3/"

	fileMode = 0o600
)

func main() {
	files, err := os.ReadDir(SchemaPath)
	if err != nil {
		log.Fatal(err)
	}

	apiCalls := `// Code generated by bin/generate_call.go, DO NOT EDIT.
package deriv

import (
	"context"

	"github.com/ksysoev/deriv-api/schema"
)

`
	subcriptionCalls := `// Code generated by bin/generate_call.go, DO NOT EDIT.
package deriv

import (
	"context"

	"github.com/ksysoev/deriv-api/schema"
)

`

	for _, file := range files {
		name := file.Name()
		request, err := os.ReadFile("deriv-api-docs/config/v3/" + name + "/send.json")

		if err != nil {
			log.Fatal(err)
		}

		var requestSchema map[string]any
		err = json.Unmarshal(request, &requestSchema)

		if err != nil {
			log.Fatal(err)
		}

		title := CreateTitle(name)

		description, _ := requestSchema["description"].(string)

		apiCalls += CreateAPICallFunction(title, description)

		if HasSubscribe(requestSchema) {
			subcriptionCalls += CreateSubscriptionCallFunction(title, description)
		}
	}

	if err := os.WriteFile(APICalls, []byte(apiCalls), fileMode); err != nil {
		log.Fatal(err)
	}

	if err := os.WriteFile(SubscriptionCalls, []byte(subcriptionCalls), fileMode); err != nil {
		log.Fatal(err)
	}
}

func HasSubscribe(r map[string]any) bool {
	rawProperties, ok := r["properties"]
	if !ok {
		return false
	}

	properties, ok := rawProperties.(map[string]any)
	if !ok {
		return false
	}

	_, ok = properties["subscribe"]

	return ok
}

func CreateTitle(name string) string {
	var title string

	for _, s := range strings.Split(name, "_") {
		if s == "p2p" {
			title += "P2P"
			continue
		}

		title += cases.Title(language.Tag{}).String(s)
	}

	return title
}

func CreateAPICallFunction(title, description string) string {
	signature := fmt.Sprintf("// %s %s\nfunc (api *DerivAPI) %s(ctx context.Context, r schema.%s) (resp schema.%sResp, err error)", title, description, title, title, title)

	body := `id := api.getNextRequestID()
	r.ReqId = &id
	err = api.SendRequest(ctx, id, r, &resp)
	return`

	return fmt.Sprintf("%s {\n\t%s\n}\n\n", signature, body)
}

func CreateSubscriptionCallFunction(title, description string) string {
	initResp := title + "Resp"

	var Resp string

	switch title {
	case "Buy":
		Resp = "ProposalOpenContractResp"
	case "TicksHistory", "Transaction":
		// this is a special case, because the response is different depending on the style
		// logic for this api call is maintained in custom_subscription_calls.go
		return ""
	case "P2POrderCreate", "P2POrderList":
		Resp = "P2POrderInfoResp"
	case "P2PAdvertiserCreate":
		Resp = "P2PAdvertInfoResp"
	default:
		Resp = initResp
	}

	signature := fmt.Sprintf("// Subscribe%s %s\nfunc (api *DerivAPI) Subscribe%s(ctx context.Context, r schema.%s) (rsp schema.%s, s *Subsciption[schema.%s, schema.%s], err error)", title, description, title, title, initResp, initResp, Resp)

	body := fmt.Sprintf(
		`id := api.getNextRequestID()
	var f schema.%sSubscribe = 1
	r.ReqId = &id
	r.Subscribe = &f
	s = NewSubcription[schema.%s, schema.%s](ctx, api)
	rsp, err = s.Start(id, r)
	return`, title, initResp, Resp)

	return fmt.Sprintf("%s {\n\t%s\n}\n\n", signature, body)
}
